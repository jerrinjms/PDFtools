
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PDF ‚Üí 4√ó6 Cropper (Modern UI + Progress)</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background-color: #f5f5f7;
      color: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 40px 20px;
    }

    h2 {
      font-weight: 600;
      margin-bottom: 8px;
      color: #111;
    }

    p {
      font-size: 14px;
      color: #555;
      margin-bottom: 24px;
      text-align: center;
      max-width: 600px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 30px 30px 40px;
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s;
      color: #777;
      font-size: 16px;
    }

    .upload-area.dragover {
      border-color: #4a90e2;
      background-color: #f0f6ff;
      color: #333;
    }

    .buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #processBtn { background-color: #4a90e2; color: white; }
    #processBtn:hover:not(:disabled) { background-color: #3578c6; }
    #downloadBtn { background-color: #34c759; color: white; }
    #downloadBtn:hover:not(:disabled) { background-color: #28a745; }

    #message { font-size: 14px; text-align: center; }
    #fileCount { font-size: 14px; text-align: center; color: #555; }

    #preview {
      width: 100%;
      height: 432px;
      border-radius: 12px;
      border: 1px solid #ddd;
      margin-top: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    #progressContainer {
      width: 100%;
      background: #eee;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    #progressBar {
      height: 100%;
      width: 0;
      background: #4a90e2;
      transition: width 0.1s;
    }

    @media(max-width: 500px) {
      .upload-area { padding: 30px 15px; font-size: 14px; }
      button { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <h1>üêä Krikey Al Fresco PDF </h1>
  <p>Upload one or more PDFs. Each page will be cropped with preset 4"√ó6" dimensions and combined into a single PDF.</p>

  <div class="card">
  <h3>ü™ö PDF 4x6in Label Generater </h3>
    <div id="uploadArea" class="upload-area">
      Drag & drop PDFs here or click to select files
    </div>
    <div id="fileCount"></div>
    <div class="buttons">
      <button id="processBtn" disabled>Crop & Preview All</button>
      <button id="downloadBtn" disabled>Download Combined PDF</button>
    </div>

    <div id="message"></div>
    <div id="progressContainer"><div id="progressBar"></div></div>

    <h4>Preview (First Page)</h4>
    <embed id="preview" type="application/pdf" width="100%" height="432" />
  </div>

  <input id="fileInput" type="file" accept="application/pdf" multiple style="display:none;" />

  <script>
    (function () {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');
      const processBtn = document.getElementById('processBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const preview = document.getElementById('preview');
      const msg = document.getElementById('message');
      const fileCountEl = document.getElementById('fileCount');
      const progressBar = document.getElementById('progressBar');

      let currentFiles = [];
      let lastObjectUrl = null;
      let lastBlob = null;

      const TARGET_W = 288;
      const TARGET_H = 432;

      // Preset crop values
      const CROP_X = 40;
      const CROP_Y = 66;
      const CROP_ZOOM = 0.9;

      function setMessage(text, isError = true) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#b00' : '#0a6';
      }

      function updateFileCount() {
        fileCountEl.textContent = currentFiles.length
          ? `${currentFiles.length} file(s) selected`
          : '';
      }

      function handleFiles(files) {
        currentFiles = Array.from(files);
        processBtn.disabled = currentFiles.length === 0;
        downloadBtn.disabled = true;
        preview.removeAttribute("src");
        lastBlob = null;
        updateFileCount();
        setMessage('');
        progressBar.style.width = '0%';
      }

      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (ev) => handleFiles(ev.target.files));

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      processBtn.addEventListener('click', async () => {
        setMessage('');
        processBtn.disabled = true;
        downloadBtn.disabled = true;
        preview.removeAttribute("src");
        if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }

        if (currentFiles.length === 0) {
          setMessage('No files selected.');
          processBtn.disabled = false;
          return;
        }

        try {
          const combinedPdf = await PDFLib.PDFDocument.create();
          let totalPages = 0;
          for (const file of currentFiles) {
            const arrayBuffer = await file.arrayBuffer();
            const srcPdf = await PDFLib.PDFDocument.load(arrayBuffer);
            totalPages += srcPdf.getPages().length;
          }

          let processedPages = 0;

          for (const file of currentFiles) {
            const arrayBuffer = await file.arrayBuffer();
            const srcPdf = await PDFLib.PDFDocument.load(arrayBuffer);
            const pages = srcPdf.getPages();

            for (const srcPage of pages) {
              const { width: w, height: h } = srcPage.getSize();
              const cropW = TARGET_W / CROP_ZOOM;
              const cropH = TARGET_H / CROP_ZOOM;
              const left = CROP_X;
              const bottom = h - CROP_Y - cropH;

              const embedded = await combinedPdf.embedPage(srcPage, {
                left: left,
                right: left + cropW,
                bottom: bottom,
                top: bottom + cropH
              });

              const newPage = combinedPdf.addPage([TARGET_W, TARGET_H]);
              newPage.drawPage(embedded, { x: 0, y: 0, width: TARGET_W, height: TARGET_H });

              processedPages++;
              progressBar.style.width = `${Math.round((processedPages/totalPages)*100)}%`;
            }
          }

          const outBytes = await combinedPdf.save();
          lastBlob = new Blob([outBytes], { type: 'application/pdf' });
          lastObjectUrl = URL.createObjectURL(lastBlob);

          preview.src = lastObjectUrl;
          downloadBtn.disabled = false;
          processBtn.disabled = false;
          setMessage('All PDFs cropped and combined ‚Äî click Download to save.', false);

        } catch (err) {
          console.error(err);
          setMessage('Processing failed. Open browser console to see the error.');
          processBtn.disabled = false;
        }
      });

      downloadBtn.addEventListener('click', () => {
        if (!lastBlob) return;
        const a = document.createElement('a');
        a.href = lastObjectUrl;
        a.download = 'combined-cropped-4x6.pdf';
        a.click();
      });
    })();
  </script>
</body>
</html>
<!-- Address Generator Section -->
<div class="card notion-card">
  <div id="addressHeader" class="notion-toggle">
    <span>üìÉ PDF Address Generator</span>
    <span id="toggleArrow">‚ñº</span>
  </div>

  <div id="addressContent" class="collapsible">
    <p>Enter addresses (3 per page). You can add more with the button below.</p>
    <div id="addressInputs">
      <textarea class="addrInput" placeholder="Address 1"></textarea>
      <textarea class="addrInput" placeholder="Address 2"></textarea>
      <textarea class="addrInput" placeholder="Address 3"></textarea>
    </div>
    <button id="addAddrBtn" class="secondary-btn">+ Add Address</button>

    <div class="buttons" style="margin-top:12px;">
      <button id="genAddrBtn">Generate Address PDF</button>
      <button id="dlAddrBtn" disabled>Download Address PDF</button>
    </div>

    <div id="addrMessage" class="message"></div>
    <h4 style="margin-top:16px;">Preview</h4>
    <embed id="addrPreview" type="application/pdf" width="100%" height="432" />
  </div>
</div>

<style>
/* Notion-inspired UI */
.notion-card {
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.04);
}

.notion-toggle {
  cursor: pointer;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 15px;
}

.collapsible {
  display: none;
  margin-top: 16px;
  transition: all 0.3s ease;
}

.addrInput {
  width: 100%;
  min-height: 80px;
  margin: 6px 0;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Segoe UI', sans-serif;
  resize: vertical;
  transition: border 0.2s, background 0.2s;
}
.addrInput:focus {
  outline: none;
  border-color: #6666ff;
  background: #fafaff;
}

.secondary-btn {
  font-size: 14px;
  padding: 6px 12px;
  border-radius: 8px;
  background: #f6f6f6;
  border: 1px solid #ddd;
  cursor: pointer;
}
.secondary-btn:hover {
  background: #efefef;
}
</style>

<script>
(function () {
  const addrHeader = document.getElementById('addressHeader');
  const addrContent = document.getElementById('addressContent');
  const toggleArrow = document.getElementById('toggleArrow');
  const addAddrBtn = document.getElementById('addAddrBtn');
  const genAddrBtn = document.getElementById('genAddrBtn');
  const dlAddrBtn = document.getElementById('dlAddrBtn');
  const addrPreview = document.getElementById('addrPreview');
  const addrMessage = document.getElementById('addrMessage');
  const addrInputs = document.getElementById('addressInputs');

  let lastAddrBlob = null;
  let lastAddrUrl = null;

  // Collapsible toggle
  addrHeader.addEventListener('click', () => {
    const isVisible = addrContent.style.display === 'block';
    addrContent.style.display = isVisible ? 'none' : 'block';
    toggleArrow.textContent = isVisible ? '‚ñº' : '‚ñ≤';
  });

  // Add new address input
  addAddrBtn.addEventListener('click', () => {
    const newBox = document.createElement('textarea');
    newBox.className = 'addrInput';
    newBox.placeholder = `Address ${addrInputs.children.length + 1}`;
    addrInputs.appendChild(newBox);
  });

  function setAddrMessage(text, isError = true) {
    addrMessage.textContent = text || '';
    addrMessage.style.color = isError ? '#b00' : '#0a6';
  }

  async function generateAddressPDF() {
  const addresses = Array.from(addrInputs.querySelectorAll('textarea'))
    .map(t => t.value.trim())
    .filter(Boolean);

  if (addresses.length === 0) {
    setAddrMessage("Please enter at least one address.");
    return;
  }

  genAddrBtn.disabled = true;
  dlAddrBtn.disabled = true;
  addrPreview.removeAttribute("src");
  if (lastAddrUrl) { URL.revokeObjectURL(lastAddrUrl); lastAddrUrl = null; }

  try {
    const pdfDoc = await PDFLib.PDFDocument.create();
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

    const PAGE_W = 288;
    const PAGE_H = 432;
    const MARGIN_TOP = 40; // shift content down
    const MARGIN_SIDE = 16;
    const LEFT_PAD = 28; // extra padding for text start
    const SECTION_H = (PAGE_H - MARGIN_SIDE) / 3;

    for (let i = 0; i < addresses.length; i++) {
      if (i % 3 === 0) {
        pdfDoc.addPage([PAGE_W, PAGE_H]);
      }
      const page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
      const text = addresses[i];

      const sectionIndex = i % 3;
      const boxBottom = PAGE_H - MARGIN_TOP - (sectionIndex + 1) * SECTION_H;
      const boxHeight = SECTION_H;

      // Dynamically adjust font size to fit both width & height
      let fontSize = 18;
      let fits = false;
      let lines = [];

      while (fontSize > 6 && !fits) {
        lines = text.split("\n");
        const lineHeight = fontSize * 1.25;
        const totalHeight = lines.length * lineHeight;

        // Check vertical fit
        let verticalOk = totalHeight <= (boxHeight - 2 * MARGIN_SIDE);

        // Check width fit (longest line must fit without wrapping)
        let widestLine = Math.max(...lines.map(line => font.widthOfTextAtSize(line, fontSize)), 0);
        let widthOk = widestLine <= (PAGE_W - LEFT_PAD - MARGIN_SIDE);

        if (verticalOk && widthOk) {
          fits = true;
        } else {
          fontSize -= 1;
        }
      }

      const lineHeight = fontSize * 1.25;
      let textBlockHeight = lines.length * lineHeight;

      // Vertical centering inside section
      let y = boxBottom + (boxHeight - textBlockHeight) / 2 + boxHeight;

      // Draw lines (left aligned, but centered block vertically)
      lines.forEach(line => {
        page.drawText(line, {
          x: LEFT_PAD,
          y: y - fontSize,
          size: fontSize,
          font: font,
          maxWidth: PAGE_W - LEFT_PAD - MARGIN_SIDE,
        });
        y -= lineHeight;
      });
    }

    const outBytes = await pdfDoc.save();
    lastAddrBlob = new Blob([outBytes], { type: 'application/pdf' });
    lastAddrUrl = URL.createObjectURL(lastAddrBlob);

    addrPreview.src = lastAddrUrl;
    dlAddrBtn.disabled = false;
    genAddrBtn.disabled = false;
    setAddrMessage("Address PDF generated successfully!", false);

  } catch (err) {
    console.error(err);
    setAddrMessage("Failed to generate Address PDF.");
    genAddrBtn.disabled = false;
    }
  }

  genAddrBtn.addEventListener('click', generateAddressPDF);

  dlAddrBtn.addEventListener('click', () => {
    if (!lastAddrBlob) return;
    const a = document.createElement('a');
    a.href = lastAddrUrl;
    a.download = 'addresses-4x6.pdf';
    a.click();
  });
})();
</script>
